<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redimensionador de Portadas EPUB</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .upload-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed #ddd;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .file-input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            transition: border-color 0.3s ease;
        }

        input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .dimensions-section {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .dimensions-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .dimension-input {
            display: flex;
            flex-direction: column;
        }

        .dimension-input input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .dimension-input input:focus {
            outline: none;
            border-color: #667eea;
        }

        .preset-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .preset-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: transform 0.2s ease;
        }

        .preset-btn:hover {
            transform: translateY(-2px);
        }

        .process-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .process-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
        }

        .process-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .preview-section {
            display: none;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            align-items: start;
        }

        .preview-item {
            text-align: center;
        }

        .preview-item h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .preview-item img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-message {
            text-align: center;
            padding: 10px;
            margin: 10px 0;
            border-radius: 6px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .download-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: none;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(23, 162, 184, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2rem;
            }

            .dimensions-grid {
                grid-template-columns: 1fr;
            }

            .preview-grid {
                grid-template-columns: 1fr;
            }

            .preset-buttons {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìö Redimensionador de Portadas EPUB</h1>
        
        <div class="upload-section">
            <div class="file-input-group">
                <label for="epubFile">Selecciona tu archivo EPUB:</label>
                <input type="file" id="epubFile" accept=".epub" required>
            </div>
            
            <div class="file-input-group">
                <label for="coverImage">Selecciona la nueva imagen de portada:</label>
                <input type="file" id="coverImage" accept="image/*" required>
            </div>
        </div>

        <div class="dimensions-section">
            <h3>Dimensiones de la portada</h3>
            <div class="preset-buttons">
                <button class="preset-btn" onclick="setDimensions(1600, 2560)">Google Play (1600√ó2560)</button>
                <button class="preset-btn" onclick="setDimensions(1563, 2500)">Amazon Kindle (1563√ó2500)</button>
                <button class="preset-btn" onclick="setDimensions(1400, 2240)">Apple Books (1400√ó2240)</button>
                <button class="preset-btn" onclick="setDimensions(1200, 1920)">Est√°ndar (1200√ó1920)</button>
            </div>
            
            <div class="dimensions-grid">
                <div class="dimension-input">
                    <label>Ancho (px):</label>
                    <input type="number" id="width" value="1600" min="100" max="5000">
                </div>
                <div class="dimension-input">
                    <label>Alto (px):</label>
                    <input type="number" id="height" value="2560" min="100" max="5000">
                </div>
            </div>
        </div>

        <button class="process-btn" id="processBtn" onclick="processEpub()">
            üîÑ Procesar EPUB
        </button>

        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="preview-section" id="previewSection">
            <h3>Vista previa de portadas</h3>
            <div class="preview-grid">
                <div class="preview-item">
                    <h4>Portada original</h4>
                    <img id="originalPreview" alt="Portada original">
                </div>
                <div class="preview-item">
                    <h4>Nueva portada redimensionada</h4>
                    <img id="newPreview" alt="Nueva portada">
                </div>
            </div>
        </div>

        <button class="download-btn" id="downloadBtn" onclick="downloadProcessedEpub()">
            ‚¨áÔ∏è Descargar EPUB Procesado
        </button>
    </div>

    <script>
        let processedEpubBlob = null;
        let originalFileName = '';

        function setDimensions(width, height) {
            document.getElementById('width').value = width;
            document.getElementById('height').value = height;
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${isError ? 'status-error' : 'status-success'}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function updateProgress(percent) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            if (percent > 0) {
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
            } else {
                progressBar.style.display = 'none';
            }
        }

        async function resizeImage(file, targetWidth, targetHeight) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    canvas.width = targetWidth;
                    canvas.height = targetHeight;
                    
                    // Calcular el escalado manteniendo proporci√≥n
                    const scale = Math.max(targetWidth / img.width, targetHeight / img.height);
                    const scaledWidth = img.width * scale;
                    const scaledHeight = img.height * scale;
                    
                    // Centrar la imagen
                    const x = (targetWidth - scaledWidth) / 2;
                    const y = (targetHeight - scaledHeight) / 2;
                    
                    // Fondo blanco
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, targetWidth, targetHeight);
                    
                    // Dibujar imagen redimensionada
                    ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                    
                    canvas.toBlob(resolve, 'image/jpeg', 0.9);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }

        async function processEpub() {
            const epubFile = document.getElementById('epubFile').files[0];
            const coverImage = document.getElementById('coverImage').files[0];
            const width = parseInt(document.getElementById('width').value);
            const height = parseInt(document.getElementById('height').value);

            if (!epubFile || !coverImage) {
                showStatus('Por favor selecciona tanto el archivo EPUB como la imagen de portada.', true);
                return;
            }

            if (!width || !height || width < 100 || height < 100) {
                showStatus('Por favor ingresa dimensiones v√°lidas (m√≠nimo 100px).', true);
                return;
            }

            try {
                document.getElementById('processBtn').disabled = true;
                updateProgress(10);
                
                originalFileName = epubFile.name.replace('.epub', '');
                
                // Mostrar vista previa de la imagen original
                const originalPreview = document.getElementById('originalPreview');
                originalPreview.src = URL.createObjectURL(coverImage);
                
                updateProgress(25);
                
                // Redimensionar imagen
                const resizedImageBlob = await resizeImage(coverImage, width, height);
                
                // Mostrar vista previa de la nueva imagen
                const newPreview = document.getElementById('newPreview');
                newPreview.src = URL.createObjectURL(resizedImageBlob);
                
                document.getElementById('previewSection').style.display = 'block';
                
                updateProgress(50);
                
                // Leer el EPUB
                const zip = new JSZip();
                const epubContent = await zip.loadAsync(epubFile);
                
                updateProgress(70);
                
                // Convertir imagen redimensionada a array de bytes
                const imageArrayBuffer = await resizedImageBlob.arrayBuffer();
                
                // Reemplazar la portada en el EPUB
                // Buscar archivos de imagen comunes para portadas
                const imageExtensions = ['jpg', 'jpeg', 'png', 'gif'];
                let coverReplaced = false;
                
                // Buscar en directorios comunes
                const commonPaths = ['OEBPS/', 'EPUB/', '', 'Images/', 'images/', 'OEBPS/Images/', 'OEBPS/images/'];
                const commonNames = ['cover', 'Cover', 'COVER', 'portada', 'Portada'];
                
                for (const path of commonPaths) {
                    for (const name of commonNames) {
                        for (const ext of imageExtensions) {
                            const fullPath = `${path}${name}.${ext}`;
                            if (epubContent.files[fullPath]) {
                                epubContent.file(fullPath, imageArrayBuffer);
                                coverReplaced = true;
                                break;
                            }
                        }
                        if (coverReplaced) break;
                    }
                    if (coverReplaced) break;
                }
                
                // Si no encontramos una portada espec√≠fica, buscar la primera imagen
                if (!coverReplaced) {
                    const imageFiles = Object.keys(epubContent.files).filter(filename => 
                        imageExtensions.some(ext => filename.toLowerCase().endsWith(`.${ext}`))
                    );
                    
                    if (imageFiles.length > 0) {
                        epubContent.file(imageFiles[0], imageArrayBuffer);
                        coverReplaced = true;
                    }
                }
                
                if (!coverReplaced) {
                    // Agregar nueva portada si no existe ninguna
                    epubContent.file('OEBPS/cover.jpg', imageArrayBuffer);
                }
                
                updateProgress(90);
                
                // Generar nuevo EPUB
                processedEpubBlob = await epubContent.generateAsync({type: 'blob'});
                
                updateProgress(100);
                
                showStatus('¬°EPUB procesado exitosamente!');
                document.getElementById('downloadBtn').style.display = 'block';
                
                setTimeout(() => updateProgress(0), 2000);
                
            } catch (error) {
                console.error('Error procesando EPUB:', error);
                showStatus('Error procesando el archivo EPUB. Aseg√∫rate de que sea un archivo v√°lido.', true);
                updateProgress(0);
            } finally {
                document.getElementById('processBtn').disabled = false;
            }
        }

        function downloadProcessedEpub() {
            if (!processedEpubBlob) {
                showStatus('No hay archivo procesado para descargar.', true);
                return;
            }
            
            const url = URL.createObjectURL(processedEpubBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${originalFileName}_redimensionado.epub`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('¬°Descarga iniciada!');
        }

        // Validaci√≥n en tiempo real de dimensiones
        document.getElementById('width').addEventListener('input', function() {
            if (this.value < 100) this.value = 100;
            if (this.value > 5000) this.value = 5000;
        });

        document.getElementById('height').addEventListener('input', function() {
            if (this.value < 100) this.value = 100;
            if (this.value > 5000) this.value = 5000;
        });
    </script>
</body>
</html>